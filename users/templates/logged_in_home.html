{% extends 'base_site.html' %}
{% load static %}
{% load i18n %}

{% block style %}
    <style>
        .gallery-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px;
            gap: 10px;
            scroll-behavior: smooth;
        }

        .gallery-item {
            min-width: 150px;
            height: 100px;
            background-color: #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            display: none;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
            color: black; /* Ensure text is visible */
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        .artist-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .artist-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center">
    <div class="text-center" style="max-width: 600px; width: 100%;">
        <h2 class="mb-4">Welcome to your Spotify Wrapped!</h2>
    </div>
</div>

<!-- Transition slides -->
<div id="transitionSlides" class="carousel slide mb-4" data-ride="carousel" style="background-color: #ffffff;">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <div class="d-block w-100" style="height: 600px; background-color: #FF5733;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #33FF57;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #3357FF;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #FF33A1;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #A133FF;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #33FFF5;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #F5FF33;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
        <div class="carousel-item">
            <div class="d-block w-100" style="height: 600px; background-color: #FF8C33;">
            <h3>Top Artists</h3>
            <ul>
                {% for artist in data %}
                <li class="artist-item">
                    <img src="{{ artist.image }}" class="artist-image" alt="{{ artist.name }}">
                    <span>{{ artist.name }}</span>
                </li>
                {% endfor %}
            </ul>
            </div>
        </div>
    </div>
    <a class="carousel-control-prev" href="#transitionSlides" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#transitionSlides" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
    <ol class="carousel-indicators">
        {% for i in "01234567" %}
            <li data-target="#transitionSlides" data-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %}"></li>
        {% endfor %}
    </ol>
</div>

<!-- Button to show the form for generating a new wrap -->
<div>
    <button id="generateWrapButton" class="btn btn-primary">Generate a New Wrap</button>
</div>

<!-- Form to specify timeframe and limit -->
<div id="wrapFormContainer" class="mt-3" style="display: none;">
    <form id="wrapForm" method="POST">
        {% csrf_token %}
        <div>
            <label for="time_range">Time Range:</label>
            <select name="time_range" id="time_range">
                <option value="short_term">Short Term</option>
                <option value="medium_term">Medium Term</option>
                <option value="long_term">Long Term</option>
            </select>
        </div>
        <div>
            <label for="limit">Limit:</label>
            <input type="number" name="limit" id="limit" min="1" max="50" value="10">
        </div>
        <button type="submit" class="btn btn-success mt-2">Generate</button>
    </form>
</div>

<!-- Modal for displaying the wrap -->
<div id="wrapModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeModal">&times;</span>
        <h3 id="modalWrapTitle"></h3>
        <h4>Top Artists:</h4>
        <ul id="modalTopArtists"></ul>
        <h4>Top Tracks:</h4>
        <ul id="modalTopTracks"></ul>
        <div class="mt-3">
            <label for="customWrapName">Custom Wrap Name:</label>
            <input type="text" id="customWrapName" placeholder="Enter a name for your wrap">
            <button id="saveWrapName" class="btn btn-success mt-2">Save</button>
            <button id="deleteWrap" class="btn btn-danger mt-2">Delete</button>
        </div>
    </div>
</div>

<!-- Gallery of saved wraps -->
<div id="wraps" class="mt-4">
    <div class="gallery-container">
        {% for wrap in wraps %}
            <div class="gallery-item" data-wrap-id="{{ wrap.id }}">
                {{ wrap.title }}
            </div>
        {% empty %}
            <p>No saved wraps yet. Generate a new wrap to see it here!</p>
        {% endfor %}
    </div>
</div>

<!-- Include the AJAX script -->
<script>
    // Function to get CSRF token from cookies
    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return null;
    }

    // Show the form for generating a new wrap
    document.querySelector('#generateWrapButton').addEventListener('click', function () {
        document.querySelector('#wrapFormContainer').style.display = 'block';
    });

    // Handle form submission to generate the wrap
    document.querySelector('#wrapForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        fetch('/wrap-generate/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showWrapDetails(data.wrap_id, data.wrap_title, data.top_artists, data.top_tracks);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Show wrap details in the modal
    function showWrapDetails(wrapId, wrapTitle, topArtists, topTracks) {
        document.querySelector('#modalWrapTitle').textContent = wrapTitle;

        const artistsList = document.querySelector('#modalTopArtists');
        artistsList.innerHTML = '';
        topArtists.forEach(artist => {
            const li = document.createElement('li');
            li.classList.add('artist-item');
            li.innerHTML = `
                <img src="${artist.image}" class="artist-image" alt="${artist.name}">
                <span>${artist.name}</span>
            `;
            artistsList.appendChild(li);
        });

        const tracksList = document.querySelector('#modalTopTracks');
        tracksList.innerHTML = '';
        topTracks.forEach(track => {
            const li = document.createElement('li');
            li.textContent = track.name;
            tracksList.appendChild(li);
        });

        // Set up delete button
        document.querySelector('#deleteWrap').dataset.wrapId = wrapId;

        document.querySelector('#wrapModal').style.display = 'flex';
    }

    // Fetch and show wrap details
    document.querySelectorAll('.gallery-item').forEach(item => {
        item.addEventListener('click', function (event) {
            event.preventDefault();
            const wrapId = this.dataset.wrapId;

            fetch(`/wrap-detail/${wrapId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showWrapDetails(data.wrap_id, data.wrap_title, data.top_artists, data.top_tracks);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Save the custom wrap name
    document.querySelector('#saveWrapName').addEventListener('click', function () {
        const customName = document.querySelector('#customWrapName').value;
        const wrapId = document.querySelector('#deleteWrap').dataset.wrapId;

        if (customName && wrapId) {
            fetch('/wrap-generate/', {
                method: 'PUT',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({
                    wrap_id: wrapId,
                    custom_title: customName,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Wrap name saved as: ${data.wrap_title}`);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    // Delete a wrap
    document.querySelector('#deleteWrap').addEventListener('click', function () {
        const wrapId = this.dataset.wrapId;

        fetch(`/wrap-delete/${wrapId}/`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Wrap deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Close the modal
    document.querySelector('#closeModal').addEventListener('click', function () {
        document.querySelector('#wrapModal').style.display = 'none';
    });
</script>
{% endblock %}
